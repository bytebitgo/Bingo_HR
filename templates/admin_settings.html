<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>系统设置 - 简历管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>系统设置</h2>
        <a href="{{ url_for('admin_users') }}" class="btn btn-outline-primary btn-sm">返回用户管理</a>
    </div>
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}
    <form method="post" class="mt-4" autocomplete="off">
        <div class="mb-3">
            <label class="form-label">是否启用Azure Key Vault</label>
            <select class="form-select" name="azure_keyvault_enable" id="azure_keyvault_enable" onchange="toggleKeyVaultFields()">
                <option value="0" {% if settings.azure_keyvault_enable=="0" %}selected{% endif %}>否</option>
                <option value="1" {% if settings.azure_keyvault_enable=="1" %}selected{% endif %}>是</option>
            </select>
        </div>
        <div id="keyvault-fields" style="display:{% if settings.azure_keyvault_enable=="1" %}block{% else %}none{% endif %};">
            <div class="mb-3">
                <label class="form-label">Key Vault 名称</label>
                <input type="text" class="form-control" name="azure_keyvault_name" value="{{ settings.azure_keyvault_name }}" autocomplete="off">
            </div>
            <div class="mb-3">
                <label class="form-label">OpenAI Key机密名称</label>
                <select class="form-select" name="azure_keyvault_secret_name" id="azure_keyvault_secret_name">
                    {% if settings.azure_keyvault_secret_name %}
                        <option value="{{ settings.azure_keyvault_secret_name }}" selected>{{ settings.azure_keyvault_secret_name }}</option>
                    {% else %}
                        <option value="">请选择或先列出机密</option>
                    {% endif %}
                </select>
            </div>
            <div class="mb-3">
                <button type="button" class="btn btn-info" id="list-keyvault-secrets-btn">列出Key Vault机密</button>
                <span id="keyvault-secrets-list" class="ms-3"></span>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">API Key</label>
            <input type="text" class="form-control" name="api_key" value="{{ settings.api_key }}" autocomplete="off">
        </div>
        <div class="mb-3">
            <label class="form-label">Endpoint</label>
            <input type="text" class="form-control" name="endpoint" value="{{ settings.endpoint }}" autocomplete="off">
        </div>
        <div class="mb-3">
            <label class="form-label">Deployment Name</label>
            <input type="text" class="form-control" name="deployment_name" value="{{ settings.deployment_name }}" autocomplete="off">
        </div>
        <div class="mb-3">
            <label class="form-label">API Version</label>
            <input type="text" class="form-control" name="api_version" value="{{ settings.api_version }}" autocomplete="off">
        </div>
        <div class="mb-3">
            <label class="form-label">数据库类型</label>
            <select class="form-select" name="db_type" id="db_type" onchange="toggleMysqlFields()">
                <option value="sqlite" {% if settings.db_type=="sqlite" %}selected{% endif %}>SQLite（本地）</option>
                <option value="mysql" {% if settings.db_type=="mysql" %}selected{% endif %}>Azure MySQL</option>
            </select>
        </div>
        <div id="mysql-fields" style="display:{% if settings.db_type=="mysql" %}block{% else %}none{% endif %};">
            <div class="mb-3">
                <label class="form-label">MySQL 用户名</label>
                <input type="text" class="form-control" name="mysql_user" value="{{ settings.mysql_user }}" autocomplete="off">
            </div>
            <div class="mb-3">
                <label class="form-label">MySQL 密码</label>
                <input type="password" class="form-control" name="mysql_password" value="{{ settings.mysql_password }}" autocomplete="off">
            </div>
            <div class="mb-3">
                <label class="form-label">MySQL Host</label>
                <input type="text" class="form-control" name="mysql_host" value="{{ settings.mysql_host }}" autocomplete="off">
            </div>
            <div class="mb-3">
                <label class="form-label">MySQL 数据库名</label>
                <input type="text" class="form-control" name="mysql_db" value="{{ settings.mysql_db }}" autocomplete="off">
            </div>
            <div class="mb-3">
                <label class="form-label">MySQL 端口</label>
                <input type="text" class="form-control" name="mysql_port" value="{{ settings.mysql_port or '3306' }}" autocomplete="off">
            </div>
            <div class="mb-3">
                <button type="button" class="btn btn-info" id="test-mysql-btn">测试Azure MySQL连通性</button>
                <span id="mysql-test-result" class="ms-3"></span>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">是否启用Azure Blob上传</label>
            <select class="form-select" name="azure_blob_enable" id="azure_blob_enable" onchange="toggleBlobFields()">
                <option value="0" {% if settings.azure_blob_enable=="0" %}selected{% endif %}>否</option>
                <option value="1" {% if settings.azure_blob_enable=="1" %}selected{% endif %}>是</option>
            </select>
        </div>
        <div id="blob-fields" style="display:{% if settings.azure_blob_enable=="1" %}block{% else %}none{% endif %};">
            <div class="mb-3">
                <label class="form-label">Azure Blob连接字符串</label>
                <input type="text" class="form-control" name="azure_blob_conn_str" value="{{ settings.azure_blob_conn_str }}" autocomplete="off">
            </div>
            <div class="mb-3">
                <label class="form-label">Azure Blob容器名</label>
                <input type="text" class="form-control" name="azure_blob_container" value="{{ settings.azure_blob_container }}" autocomplete="off">
            </div>
        </div>
        <script>
        function toggleMysqlFields() {
            var dbType = document.getElementById('db_type').value;
            document.getElementById('mysql-fields').style.display = dbType === 'mysql' ? 'block' : 'none';
        }
        function toggleBlobFields() {
            var enable = document.getElementById('azure_blob_enable').value;
            document.getElementById('blob-fields').style.display = enable === '1' ? 'block' : 'none';
        }
        function toggleKeyVaultFields() {
            var enable = document.getElementById('azure_keyvault_enable').value;
            document.getElementById('keyvault-fields').style.display = enable === '1' ? 'block' : 'none';
        }
        document.addEventListener('DOMContentLoaded', function() {
            toggleBlobFields();
            document.getElementById('test-mysql-btn')?.addEventListener('click', function() {
                var form = this.closest('form');
                var data = new FormData(form);
                fetch('/admin/mysql_test', {
                    method: 'POST',
                    body: data
                }).then(r => r.json()).then(res => {
                    var el = document.getElementById('mysql-test-result');
                    el.innerText = res.msg;
                    el.style.color = res.success ? 'green' : 'red';
                }).catch(() => {
                    var el = document.getElementById('mysql-test-result');
                    el.innerText = '请求失败';
                    el.style.color = 'red';
                });
            });
            document.getElementById('azure_blob_enable').addEventListener('change', toggleBlobFields);
            toggleKeyVaultFields();
            document.getElementById('azure_keyvault_enable').addEventListener('change', toggleKeyVaultFields);
            document.getElementById('list-keyvault-secrets-btn').addEventListener('click', function() {
                var keyvaultName = document.querySelector('input[name="azure_keyvault_name"]').value.trim();
                var resultSpan = document.getElementById('keyvault-secrets-list');
                var secretSelect = document.getElementById('azure_keyvault_secret_name');
                if (!keyvaultName) {
                    resultSpan.innerText = '请先填写Key Vault名称';
                    resultSpan.style.color = 'red';
                    secretSelect.innerHTML = '<option value="">请选择或先列出机密</option>';
                    return;
                }
                resultSpan.innerText = '查询中...';
                resultSpan.style.color = '#333';
                var formData = new FormData();
                formData.append('keyvault_name', keyvaultName);
                fetch('/admin/keyvault_list_secrets', {
                    method: 'POST',
                    body: formData
                }).then(r => r.json()).then(res => {
                    if (res.success) {
                        if (res.secrets.length === 0) {
                            resultSpan.innerText = '无机密';
                            secretSelect.innerHTML = '<option value="">无机密</option>';
                        } else {
                            resultSpan.innerText = '机密：' + res.secrets.join(', ');
                            secretSelect.innerHTML = '';
                            res.secrets.forEach(function(name, idx) {
                                var opt = document.createElement('option');
                                opt.value = name;
                                opt.text = name;
                                if (idx === 0) opt.selected = true;
                                secretSelect.appendChild(opt);
                            });
                        }
                        resultSpan.style.color = 'green';
                    } else {
                        resultSpan.innerText = res.msg;
                        resultSpan.style.color = 'red';
                        secretSelect.innerHTML = '<option value="">请选择或先列出机密</option>';
                    }
                }).catch(() => {
                    resultSpan.innerText = '请求失败';
                    resultSpan.style.color = 'red';
                    secretSelect.innerHTML = '<option value="">请选择或先列出机密</option>';
                });
            });
        });
        </script>
        <button type="submit" class="btn btn-success">保存设置</button>
    </form>
</div>
</body>
</html> 